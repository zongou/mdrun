# Package Building System

[Get ndk](https://github.com/android/ndk/releases)

## Env

Run with env

```sh
TARGET=${TARGET-$(uname -m)-linux-android24}
case ${TARGET} in
*-linux-android*)
    if [ ${ANDROID_NDK_ROOT+1} ]; then
        export PATH=${ANDROID_NDK_ROOT}/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
    else
        echo "Error: ANDROID_NDK_ROOT is not set"
        exit 1
    fi
    ;;
*) echo "Error: Unsupported target: ${TARGET}" ;;
esac

# Function to set environment variables based on available commands
set_tool() {
    local envKey="$1"
    shift
    for tool in "$@"; do
        if command -v "${tool}" >/dev/null; then
            export "$envKey=$(command -v "${tool}")"
            return 0
        fi
    done
    echo "No suitable tool found for $envKey" >&2
    return 1
}

# Set CC (C compiler)
if ! set_tool CC "${TARGET}-clang" "${TARGET}-cc"; then
    unset CC
fi

# Set CXX (C++ compiler)
if ! set_tool CXX "${TARGET}-clang++" "${TARGET}-c++"; then
    unset CXX
fi

# Set LD (linker)
if ! set_tool LD "${TARGET}-ld" "ld.lld" "ld"; then
    unset LD
fi

# Set other tools (AR, STRIP, OBJDUMP)
for envKey in AR OBJCOPY STRIP OBJDUMP RANLIB AS NM READELF; do
	tool=$(echo "${envKey}" | tr '[:upper:]' '[:lower:]')
    set_tool "$envKey" "${TARGET}-${tool}" "llvm-${tool}" "${tool}"
done

export ROOT=$(dirname "$(realpath "${MD_FILE}")")
export BUILD_DIR=${ROOT}/build/${TARGET}
export OUTPUT_DIR=${ROOT}/output/${TARGET}
export SRCS_DIR=${ROOT}/sources
export NCPU=$(nproc --all)

mkdir -p "${BUILD_DIR}" "${OUTPUT_DIR}" "${SRCS_DIR}"
mkdir -p "${OUTPUT_DIR}/bin" "${OUTPUT_DIR}/lib" "${OUTPUT_DIR}/include"

$@
```

### .Build

```sh
export PKG=$1
export PKG_DIR=${ROOT}/pkgs/${PKG}

for depend in $(${MD_EXE} --file=${PKG_DIR}/build.md depends 2>/dev/null); do
    echo "Checking ${depend}..."
    if ! ${MD_EXE} --file=${ROOT}/pkgs/${depend}/build.md check; then
        echo "Building ${depend}"
        ${MD_EXE} env -- ${MD_EXE} env .build -- "${depend}"
    fi
done

${MD_EXE} --file=${PKG_DIR}/build.md configure
${MD_EXE} --file=${PKG_DIR}/build.md build
${MD_EXE} --file=${PKG_DIR}/build.md test
```

### .Test

```sh
for env in \
    CC \
    CXX \
    LD \
    AR \
    OBJCOPY \
    STRIP \
    OBJDUMP \
    RANLIB \
    AS \
    NM \
    READELF \
    ROOT \
    BUILD_DIR \
    OUTPUT_DIR \
    SRCS_DIR; do

    eval echo "${env}=\${${env}}"
done
```

## Build

Build a package

```sh
${MD_EXE} env -- ${MD_EXE} env .build -- $@
```

## Test

Print env variables

```sh
${MD_EXE} env -- ${MD_EXE} env .test
```
